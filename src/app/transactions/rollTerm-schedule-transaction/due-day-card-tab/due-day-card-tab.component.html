<mat-card class="mat-elevation-z20 container-custom">
  <mat-card-content>
    <div fxLayout="row wrap" fxLayoutGap="2%" fxLayout.lt-md="column" [formGroup]="formDate">
      <mat-form-field fxFlex="31%">
        <mat-label>{{'Transactions.RollTernSchedule.DueDayCardTab.fromDate'|translate}}</mat-label>
        <input matInput [matDatepicker]="transactionDateFromPicker"   formControlName="fromDate" />
        <mat-datepicker-toggle matSuffix [for]="transactionDateFromPicker"></mat-datepicker-toggle>
        <mat-datepicker #transactionDateFromPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field fxFlex="31%">
        <mat-label>{{'Transactions.RollTernSchedule.DueDayCardTab.toDate'|translate}}</mat-label>
        <input matInput [matDatepicker]="transactionDateToPicker"  formControlName="toDate" />
        <mat-datepicker-toggle matSuffix [for]="transactionDateToPicker"></mat-datepicker-toggle>
        <mat-datepicker #transactionDateToPicker></mat-datepicker>
      </mat-form-field>
    </div>
    <div class="container" fxLayout="row wrap" fxLayoutGap="2%" fxLayout.lt-md="column"></div>
  </mat-card-content>

  <div fxLayout="row wrap" fxLayoutGap="2%" fxLayout.lt-md="column" [formGroup]="formFilter">
    <mat-form-field fxFlex="18%" *midasHasPermission="'REFINANCE_EXECUTIVE'">
      <mat-label>{{'Transactions.RollTernSchedule.DueDayCardTab.OfficeFilter'|translate}}</mat-label>
      <mat-select formControlName="OfficeFilter">
        <mat-option *ngFor="let office of offices" [value]="office.officeId">
          {{ office.name }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field fxFlex="18%" *midasHasPermission="'REFINANCE_EXECUTIVE'">
      <mat-label>{{'Transactions.RollTernSchedule.DueDayCardTab.staffFilter'|translate}}</mat-label>
      <mat-select matSelect matNativeControl formControlName="staffFilter">
        <mat-option *ngFor="let option of staffs" [value]="option.id">
          {{ option.displayName }}
        </mat-option>
      </mat-select>
    </mat-form-field>
    <mat-form-field fxFlex="18%">
      <mat-label>{{'Transactions.RollTernSchedule.DueDayCardTab.stageFilter'|translate}}</mat-label>
      <select matSelect matNativeControl formControlName="stageFilter">
        <option *ngFor="let status of statusOption" [value]="status.refid">
          {{ status.value }}
        </option>
      </select>
    </mat-form-field>

    <mat-form-field fxFlex="18%">
      <mat-label>{{'Transactions.RollTernSchedule.DueDayCardTab.statusFilter'|translate}}</mat-label>
      <select matSelect matNativeControl formControlName="statusFilter">
        <option *ngFor="let status of noteOption" [value]="status.refid">
          {{ status.value }}
        </option>
      </select>
    </mat-form-field>

    <mat-form-field fxFlex="18%">
      <mat-label>{{'Transactions.RollTernSchedule.DueDayCardTab.bankName'|translate}}</mat-label>
      <select matSelect matNativeControl formControlName="bankName">
        <option value="ALL">
          {{'Transactions.RollTernSchedule.DueDayCardTab.allBank'|translate}}
        </option>
        <option *ngFor="let bank of listBank" [value]="bank.bankCode">
          {{ bank.bankName }}
        </option>
      </select>
    </mat-form-field>

    <mat-form-field fxFlex="18%">
      <mat-label>{{'Transactions.RollTernSchedule.DueDayCardTab.cardType'|translate}}</mat-label>
      <select matSelect matNativeControl formControlName="cardType">
        <option value="ALL">
          {{'Transactions.RollTernSchedule.DueDayCardTab.allcardType'|translate}}
        </option>
        <option *ngFor="let card of cardTypeOption" [value]="card.code">
          {{ card.description }}
        </option>
      </select>
    </mat-form-field>

    <mat-form-field fxFlex="18%">
      <mat-label>{{'Transactions.RollTernSchedule.DueDayCardTab.query'|translate}}</mat-label>
      <input matInput formControlName="query" />
    </mat-form-field>
    <mat-form-field fxFlex="18%">
      <mat-label>{{'Transactions.RollTernSchedule.DueDayCardTab.status'|translate}}</mat-label>
      <select matSelect matNativeControl formControlName="cardHoldFilter">
        <option *ngFor="let status of cardHoldOption" [value]="status.code">
          {{ status.description }}
        </option>
      </select>
    </mat-form-field>
    <div fxFlex="18%" fxLayout="row wrap" fxLayoutGap="2%" fxLayout.lt-md="column">
      <mat-label ></mat-label>
      <mat-checkbox fxFlex="100%" labelPosition="after" formControlName="viewDoneTransaction" class="margin-v">
        {{'Transactions.RollTernSchedule.DueDayCardTab.viewDoneTransaction'|translate}}
      </mat-checkbox>

    </div>
    <div fxFlex="20%">
      <button
        *ngIf="fromDateAndToDate"
        (click)="getRollTermScheduleAndCardDueDayInfo()"
        style="align-self: center"
        color="primary"
        mat-raised-button
      >
      {{'Transactions.RollTernSchedule.DueDayCardTab.search'|translate}}&nbsp;<i class="fa fa-search" aria-hidden="true"></i>
      </button>
      <h3 *ngIf="!fromDateAndToDate">
        {{'Transactions.RollTernSchedule.DueDayCardTab.selectTime'|translate}}&nbsp; <i class="fa fa-calendar" style="align-self: center" aria-hidden="true"></i>
      </h3>
    </div>
  </div>

  <mat-card-content>
    <table mat-table multiTemplateDataRows [dataSource]="dataSource" class="mat-elevation-z8">
      <ng-container matColumnDef="panHolderName">
        <th mat-header-cell fxHide fxShow.gt-md *matHeaderCellDef>{{'Transactions.RollTernSchedule.DueDayCardTab.panHolderName'|translate}}</th>
        <td mat-cell fxHide fxShow.gt-md *matCellDef="let transaction">
          <a href="/#/clients/{{ transaction.clientId }}/general?typeViewClient=view">
            <mat-icon style="color: black" title="Chi tiết">{{'Transactions.RollTernSchedule.DueDayCardTab.person'|translate}}</mat-icon>
            {{ transaction.clientName }}<br />
          </a>
          <mat-label style="font-size: small" *ngIf="transaction.groupName">
            <a href="javascript:void(0)">
              <mat-icon style="color: black; " title="Thuộc đại lý">{{'Transactions.RollTernSchedule.DueDayCardTab.groups'|translate}}</mat-icon>
              {{ transaction.groupName }}
            </a>
            <br />
          </mat-label>
          <mat-label style="font-size: small" title="Số dư tài khoản">
            <mat-icon style="color: green">{{'Transactions.RollTernSchedule.DueDayCardTab.monetization_on'|translate}}</mat-icon>

            {{ transaction.accountBalanceDerived | money }}
          </mat-label>
          <br />
          <mat-label (click)="showHistoryTransaction(transaction.clientId)" title="Xem lịch sử giao dịch 90 ngày gần nhất">
            <mat-icon style="color: black">fact_check</mat-icon>
            <a style="color: black;" href="javascript:void(0)">
              {{'Transactions.RollTernSchedule.DueDayCardTab.showHistoryTransaction'|translate}}
            </a>
          </mat-label>
        </td>
      </ng-container>

      <ng-container matColumnDef="phone">
        <th mat-header-cell fxHide fxShow.gt-md *matHeaderCellDef>{{'Transactions.RollTernSchedule.DueDayCardTab.phone'|translate}}<br/> {{'Transactions.RollTernSchedule.DueDayCardTab.bankCode'|translate}}</th>
        <td mat-cell fxHide fxShow.gt-md *matCellDef="let card">
          {{ card.clientPhone }} <br />
          {{ card.cardNumber.replace("XXX-XXX", "X") }} (
            <span style="color: red; font-weight: bold">{{ card.bankCode }}</span>
            )
        </td>
      </ng-container>

      <ng-container matColumnDef="cardNumber">
        <th mat-header-cell  *matHeaderCellDef>{{'Transactions.RollTernSchedule.DueDayCardTab.officeName'|translate}}<br/> {{'Transactions.RollTernSchedule.DueDayCardTab.staffName'|translate}}</th>
        <td mat-cell *matCellDef="let card">
          <label style="color: blue; font-weight: bold;">
            {{ card.officeName }} <br />
            {{ card.staffName }}
            </label>
        </td>
      </ng-container>

      <ng-container matColumnDef="dueDay">
        <th mat-header-cell fxHide fxShow.gt-md *matHeaderCellDef>{{'Transactions.RollTernSchedule.DueDayCardTab.dueDay'|translate}} <br /> {{'Transactions.RollTernSchedule.DueDayCardTab.expiredDate'|translate}}<br /> {{'Transactions.RollTernSchedule.DueDayCardTab.expiredDate2'|translate}}</th>
        <td mat-cell fxHide fxShow.gt-md *matCellDef="let card">
          <mat-form-field>
            <input style="color: green; font-weight: bold" matInput type="text" [(ngModel)]="card.dueDay" mask="00" />
            <hr style="font-weight: bold;">
            <input style="color: red; font-weight: bold" type="text" matInput [(ngModel)]="card.expiredDateString" mask="00/00" />

          </mat-form-field>
        </td>
      </ng-container>

      <ng-container matColumnDef="isHold">
        <th mat-header-cell *matHeaderCellDef>{{'Transactions.RollTernSchedule.DueDayCardTab.isHold'|translate}}</th>
        <td mat-cell *matCellDef="let card">
          <input matCheckbox type="checkbox" [(ngModel)]="card.isHold" [checked]="card.isHold == 1" />
        </td>
      </ng-container>

      <ng-container matColumnDef="status">
        <th mat-header-cell  *matHeaderCellDef>{{'Transactions.RollTernSchedule.DueDayCardTab.status2'|translate}}</th>
        <td mat-cell   *matCellDef="let card">
          <mat-form-field appearance="outline">
            <select  matSelect [(ngModel)]="card.trackingState" matNativeControl>
              <option *ngFor="let status of statusOption" [value]="status.refid">
                {{ status.value }}
              </option>
            </select>
          </mat-form-field>
        </td>
      </ng-container>
      <ng-container matColumnDef="note">
        <th mat-header-cell   *matHeaderCellDef>{{'Transactions.RollTernSchedule.DueDayCardTab.note'|translate}}</th>
        <td mat-cell  *matCellDef="let card">
          <mat-form-field appearance="outline">
            <select matSelect [(ngModel)]="card.note" matNativeControl>
              <option *ngFor="let status of noteOption" [value]="status.refid">
                {{ status.value }}
              </option>
            </select>
          </mat-form-field>
        </td>
      </ng-container>
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef  >{{'Transactions.RollTernSchedule.DueDayCardTab.actions'|translate}}</th>
        <td mat-cell *matCellDef="let card; let i = dataIndex" style="width: 8% !important; text-align: center;">
          <mat-icon style="color: green;" title="Cập nhật" (click)="updateCardTrackingState(i)">save</mat-icon>
          <mat-icon style="color: blue;" title="Nhận phí" (click)="advanceCash(card.refId, card.clientId)"
            >attach_money</mat-icon
          >
          <!-- <mat-icon style="color: red" title="Lên lịch Advance" (click)="showCreateRollTermScheduleDialog(card)"
            >format_list_numbered_rtl
            </mat-icon> -->
        </td>
      </ng-container>
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell fxShow fxHide.gt-md *matCellDef="let element" [attr.colspan]="displayedColumns.length">
          <div class="example-element-detail" [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
            <div class="example-element-description" fxLayout="column">
              <div><span style="font-weight: bold"> {{'Transactions.RollTernSchedule.DueDayCardTab.panHolderName2'|translate}}</span>&nbsp;{{ element.panHolderName }}</div>
              <div><span style="font-weight: bold"> {{'Transactions.RollTernSchedule.DueDayCardTab.clientPhone'|translate}}</span>&nbsp; &nbsp;{{ element.clientPhone }}</div>
              <div><span style="font-weight: bold"> {{'Transactions.RollTernSchedule.DueDayCardTab.identifierId'|translate}}</span>&nbsp; &nbsp;{{ element.identifierId }}</div>
            </div>
          </div>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>

      <tr
        mat-row
        *matRowDef="let element; columns: displayedColumns"
        class="example-element-row"
        [class.example-expanded-row]="expandedElement === element"
        (click)="expandedElement = expandedElement === element ? null : element"
      ></tr>
      <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
    </table>
  </mat-card-content>
  <div *ngIf="isLoading" style="display: flex; justify-content: center; align-items: center; background: white">
    <mat-progress-spinner color="warn" mode="indeterminate"> </mat-progress-spinner>
  </div>

  <mat-paginator
    paginator
    [length]="transactionsData?.sum"
    [pageSize]="10"
    [pageSizeOptions]="[10, 25, 50, 100]"
    showFirstLastButtons
    (page)="getRollTermScheduleAndCardDueDayInfo()"
  ></mat-paginator>
  </mat-card
>

<mat-card class="mat-elevation-z20 container-custom">
  <mat-card-content>
    <div fxLayout="row wrap" fxLayoutGap="2%" fxLayout.lt-md="column" [formGroup]="formDate">
      <mat-form-field fxFlex="31%">
        <mat-label>Transaction Date From</mat-label>
        <input matInput [matDatepicker]="transactionDateFromPicker" formControlName="fromDate" />
        <mat-datepicker-toggle matSuffix [for]="transactionDateFromPicker"></mat-datepicker-toggle>
        <mat-datepicker #transactionDateFromPicker></mat-datepicker>
      </mat-form-field>

      <mat-form-field fxFlex="31%">
        <mat-label>Transaction Date To</mat-label>
        <input matInput [matDatepicker]="transactionDateToPicker" formControlName="toDate" />
        <mat-datepicker-toggle matSuffix [for]="transactionDateToPicker"></mat-datepicker-toggle>
        <mat-datepicker #transactionDateToPicker></mat-datepicker>
      </mat-form-field>
      <div fxFlex="31%">
        <button
          *ngIf="fromDateAndToDate"
          (click)="getTransaction()"
          style="align-self: center"
          color="primary"
          mat-raised-button
        >
          Tìm kiếm &nbsp;<i class="fa fa-search" aria-hidden="true"></i>
        </button>
        <button style="margin: 5px; height: 40px" (click)="exportAsXLSX()" color="primary" mat-raised-button>
          Tải danh sách giao dịch
        </button>
        <h3 *ngIf="!fromDateAndToDate">
          Vui lòng chọn thời gian &nbsp; <i class="fa fa-calendar" style="align-self: center" aria-hidden="true"></i>
        </h3>
      </div>

    </div>
    <div fxLayout="row wrap" fxLayoutGap="2%" fxLayout.lt-md="column" [formGroup]="formFilterPartner">
      <mat-form-field fxFlex="18%">
        <mat-label>Đối tác</mat-label>
        <mat-select formControlName="partnerCode">
          <mat-option *ngFor="let partner of partners" [value]="partner.externalId">
            {{ partner.displayName }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field fxFlex="18%">
        <mat-label>Ngân hàng</mat-label>
        <mat-select required formControlName="bankCode">
          <mat-option *ngFor="let bank of banks" [value]="bank.bankCode">
            {{ bank.bankName }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-form-field fxFlex="36%">
        <mat-label>Mã máy</mat-label>
        <mat-select formControlName="terminalId">
          <mat-option *ngFor="let terminal of terminals" [value]="terminal.terminalId">
            {{ terminal.terminalName }}
          </mat-option>
        </mat-select>
      </mat-form-field>



    </div>
    <div class="container" fxLayout="row wrap" fxLayoutGap="2%" fxLayout.lt-md="column"></div>
  </mat-card-content>
  <mat-card-content style="margin-top: 10px">
    <mat-card>
      <div fxLayout="row swap" fxLayoutAlign.lt-sm="center" fxLayoutGap="2%" fxLayout.lt-md="column">
        <div fxLayout="row" fxFlex="18%" class="export-item">
          <img src="assets/images/icons/transaction_total.svg" />
          <div fxLayout="column">
            <span class="money-total">{{ filterData?.length }}</span>
            <span>Tổng giao dịch </span>
          </div>
        </div>
        <div fxLayout="row wrap" fxFlex="20%" class="container m-b-20">
          <img src="assets/images/icons/money.svg" />
          <div style="display: flex" fxLayout="column">
            <span style="font-size: 20px; margin-top: 8px; padding-top: 5px">{{ totalTerminalAmount | money }}</span>
            <span>&nbsp;Tổng tiền giao dịch</span>
          </div>
        </div>
        <div fxLayout="row wrap" fxFlex="20%" class="container m-b-20">
          <img src="assets/images/icons/transaction.svg" />
          <div style="display: flex" fxLayout="column">
            <span style="font-size: 20px; margin-top: 8px; padding-top: 5px">{{ totalFeeAmount | money }}</span>
            <span>&nbsp;Phí thu được ({{ (totalFeeAmount / totalTerminalAmount) * 100 | number: "1.0-2" }}%)</span>
          </div>
        </div>
        <!-- <div fxLayout="row wrap" *midasHasPermission="'POS_UPDATE'" fxFlex="20%" class="container m-b-20">
          <img src="assets/images/icons/capital.svg" />
          <div style="display: flex" fxLayout="column">
            <span style="font-size: 20px; margin-top: 8px; padding-top: 5px">{{ totalCogsAmount | money }}</span>
            <span>&nbsp; SP vốn</span>
          </div>
        </div> -->
        <!-- <div *midasHasPermission="'POS_UPDATE'" fxLayout="row wrap" fxFlex="20%" class="container m-b-20">
          <img src="assets/images/icons/pnlAmount.svg" />
          <div style="display: flex" fxLayout="column">
            <span style="font-size: 20px; margin-top: 8px; padding-top: 5px">{{ totalPnlAmount | money }}</span>
            <span> &nbsp;PNL</span>
          </div>
        </div> -->
      </div>
    </mat-card>
  </mat-card-content>

  <mat-card-content>
    <table mat-table multiTemplateDataRows class="mat-elevation-z8" [dataSource]="dataSource" matSort>
      <!-- <ng-container matColumnDef="productId">
        <th mat-header-cell fxHide fxShow.gt-md *matHeaderCellDef mat-sort-header>Loại giao dịch</th>
        <td mat-cell fxHide fxShow.gt-md *matCellDef="let transaction" style="width: 80px">
          <span class="productId">{{ displayProductId(transaction.productId) }}</span>
        </td>
      </ng-container>
      -->
      <ng-container matColumnDef="txnDate">
        <th mat-header-cell fxHide fxShow.gt-md *matHeaderCellDef mat-sort-header>Ngày giao dịch</th>

        <td mat-cell fxHide fxShow.gt-md style="word-wrap: break-word;" *matCellDef="let journalEntry">
          <span [ngSwitch]="journalEntry.status">
            <img *ngSwitchCase="'C'" src="assets/images/icons/check.svg" />
            <img *ngSwitchCase="'P'" src="assets/images/icons/pending.svg" />
            <img *ngSwitchCase="'V'" src="assets/images/icons/cancel.svg" />
            <img *ngSwitchDefault src="assets/images/icons/question.svg" />
          </span>
          {{ journalEntry.txnDate | date: "dd-MM-yyyy HH:mm:ss" }}
          <!-- <br />
          <span class="green_text">{{ journalEntry.trnRefNo }}</span>
          <br />
          <label class="red_text" *ngIf="checkB(journalEntry.type)">
            {{ journalEntry.type }}
          </label> -->
        </td>

      </ng-container>

      <ng-container matColumnDef="terminalName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          Máy Pos / <br />
          Đối tác
        </th>
        <td mat-cell *matCellDef="let journalEntry" style="word-wrap: break-word; width: 200px">
          <span class="red_text">{{ journalEntry.terminalId }}</span> <br />
          <span class="blue_text" >{{ displayPartnerPos(journalEntry.terminalId) }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="bankName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          Ngân hàng
        </th>
        <td mat-cell *matCellDef="let journalEntry" style="word-wrap: break-word; width: 200px">
          <span class="green_text" >{{ displayBankPos(journalEntry.terminalId) }}</span>
        </td>
      </ng-container>

      <ng-container matColumnDef="panHolderName">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Khách hàng</th>
        <td mat-cell *matCellDef="let journalEntry">
          {{ journalEntry.panHolderName }} <br />
          <!-- <span class="green_text">{{ journalEntry.agencyName == "#" ? "" : journalEntry.agencyName }}</span> -->
        </td>
      </ng-container>

      <!-- <ng-container matColumnDef="panBank">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          Thẻ /<br />
          Ngân hàng
        </th>
        <td mat-cell *matCellDef="let journalEntry">
          {{ journalEntry.panNumber.replace("XXX-XXX", "X") }} <br />
          <span class="blue_text">({{ journalEntry.panBank }})</span>
        </td>
      </ng-container> -->

      <ng-container matColumnDef="terminalAmount">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>Số tiền giao dịch</th>
        <td mat-cell style="padding: 6px" *matCellDef="let transaction">
          {{ transaction.terminalAmount | money }}

          <!-- <span *midasHasPermission="'BILLER_HO'">
            <button
              title="Tải hóa đơn"
              mat-mini-fab
              *midasHasActiveModule="'billModule'"
              (click)="downloadVoucher(transaction.refid)"
              color="basic"
            >
              <img src="assets/images/icons/bill.svg" />
            </button>
          </span> -->
        </td>
      </ng-container>

      <ng-container matColumnDef="traceNo">
        <th mat-header-cell fxHide fxShow.gt-md *matHeaderCellDef mat-sort-header>
          Số hóa đơn
        </th>
        <td mat-cell fxHide fxShow.gt-md *matCellDef="let journalEntry">
          <label>{{ journalEntry.traceNo }}</label>
        </td>
      </ng-container>

      <ng-container matColumnDef="batchNo">
        <th mat-header-cell fxHide fxShow.gt-md *matHeaderCellDef mat-sort-header>
          Số lô
        </th>
        <td mat-cell fxHide fxShow.gt-md *matCellDef="let journalEntry">
          <label>{{ journalEntry.batchNo }}</label>
        </td>
      </ng-container>

      <ng-container matColumnDef="terminalAmount_feeAmount">
        <th mat-header-cell fxHide fxShow.gt-md *matHeaderCellDef mat-sort-header>Phí POs</th>
        <td mat-cell fxHide fxShow.gt-md *matCellDef="let journalEntry">
          {{ journalEntry.feeAmount | money }}
        </td>
      </ng-container>

      <!-- <ng-container matColumnDef="actions" style="width: 25px">
        <th mat-header-cell *matHeaderCellDef mat-sort-header></th>
        <td mat-cell *matCellDef="let transaction">
          <span
            style="float: right; width: 15px"
            [matMenuTriggerData]="transaction"
            [matMenuTriggerFor]="transactionMenu"
            (menuOpened)="menuOpened()"
            (menuClosed)="menuClosed()"
            ><i class="fa fa-ellipsis-v" aria-hidden="true"></i
          ></span>
        </td>
      </ng-container> -->
      <ng-container matColumnDef="expandedDetail">
        <td mat-cell fxShow fxHide.gt-md *matCellDef="let element" [attr.colspan]="displayedColumns.length">
          <div class="example-element-detail" [@detailExpand]="element == expandedElement ? 'expanded' : 'collapsed'">
            <div class="example-element-description" fxLayout="column">
              <!-- <div><span style="font-weight: bold"> Loại giao dịch :</span>&nbsp;{{ element.productId }}</div> -->
              <div>
                <span style="font-weight: bold"> Ngày giao dịch :</span>&nbsp; &nbsp;{{
                  element.txnDate | date: "dd-MM-yyyy HH:ss"
                }}
              </div>
              <!-- <div><span style="font-weight: bold"> Số giao dịch :</span>&nbsp; &nbsp;{{ element.trnRefNo }}</div> -->
              <div>
                <span style="font-weight: bold"> Trạng thái:</span>&nbsp; &nbsp;
                <span [ngSwitch]="element.status">
                  <img *ngSwitchCase="'C'" src="assets/images/icons/check.svg" />
                  <img *ngSwitchCase="'P'" src="assets/images/icons/pending.svg" />
                  <img *ngSwitchCase="'V'" src="assets/images/icons/cancel.svg" />
                  <img *ngSwitchDefault src="assets/images/icons/question.svg" />
                </span>
              </div>
              <div>
                <span style="font-weight: bold"> Phí thu được :</span>&nbsp; &nbsp;{{ element.feeAmount | money }}
              </div>
              <div><span style="font-weight: bold"> SP vốn :</span>&nbsp; &nbsp;{{ element.cogsAmount | money }}</div>
              <div *midasHasPermission="'POS_UPDATE'">
                <span style="font-weight: bold"> PNL :</span>&nbsp; &nbsp;{{ element.pnlAmount | money }}
              </div>
            </div>
          </div>
        </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let element; columns: displayedColumns"
        class="example-element-row"
        [class.example-expanded-row]="expandedElement === element"
        (click)="expandedElement = expandedElement === element ? null : element"
      ></tr>
      <tr mat-row *matRowDef="let row; columns: ['expandedDetail']" class="example-detail-row"></tr>
      <!--[routerLink]="['transactions/view', row.transactionId]"-->
    </table>
  </mat-card-content>

  <mat-menu #transactionMenu="matMenu" [overlapTrigger]="false" style="width: 50px">
    <ng-template
      matMenuContent
      let-custId="custId"
      let-type="type"
      let-status="status"
      let-txnDate="txnDate"
      let-ext7="ext7"
      let-agencyId="agencyId"
      let-refid="refid"
      let-trnRefNo="trnRefNo"
      let-batchNo="batchNo"
      let-traceNo="traceNo"
      style="width: 50px"
    >
      <button
        mat-menu-item
        [routerLink]="['/transaction/batch-transaction/', agencyId]"
        [queryParams]="{ batchTxnName: type }"
        *ngIf="
          type != 'rollTerm' &&
          type != 'cash' &&
          status == 'C' &&
          (today | date: 'dd/MM/yyyy') == (txnDate | date: 'dd/MM/yyyy')
        "
      >
        <img src="assets/images/icons/next.svg" />&nbsp;Tiếp tục giao dịch
      </button>
      <button mat-menu-item [routerLink]="['/transaction', 'view']" [queryParams]="{ tranId: refid }">
        <i class="fa fa-eye" aria-hidden="true"></i>&nbsp;Chi tiết
      </button>
      <button *midasHasPermission="'TRACE_BATCH_NO_UPDATE'" mat-menu-item (click)="addPosInformation(trnRefNo, batchNo, traceNo)">
        <img src="assets/images/icons/add.svg" /> Cập nhật Thông tin bill nhiệt
      </button>
      <button *midasHasActiveModule="'billModule'" mat-menu-item (click)="downloadVoucher(refid)">
        <img *ngIf="status != 'V'" src="assets/images/icons/order.svg" />&nbsp; Tải xuống hóa đơn
      </button>
      <!-- <button mat-menu-item *ngIf="ext7 != null && status != 'V'" (click)="downloadBill(custId, ext7)">
        <img src="assets/images/icons/bill.svg" />&nbsp; Tải xuống bill
      </button> -->
      <!-- <button *ngIf="ext7 == null && status != 'V'" (click)="uploadBill(refid, trnRefNo)" mat-menu-item>
        <img src="assets/images/icons/upload_bill.svg" />&nbsp; Upload bill
      </button> -->
      <hr />
      <button mat-menu-item *ngIf="status == 'V' && type != 'rollTerm'" (click)="undoRevertTransaction(refid)">
        <i class="fa fa-undo" aria-hidden="true"></i> &nbsp;Hoàn tác giao dịch
      </button>
      <button mat-menu-item *ngIf="status != 'V'" (click)="revertTransaction(refid)">
        <i class="fa fa-ban" aria-hidden="true"></i> &nbsp;Hủy giao dịch
      </button>
    </ng-template>
  </mat-menu>
  <div *ngIf="isLoading" style="display: flex; justify-content: center; align-items: center; background: white">
    <mat-progress-spinner color="warn" mode="indeterminate"> </mat-progress-spinner>
  </div>
  <mat-paginator
    paginator
    [length]="filterData?.length"
    [pageSize]="10"
    [pageSizeOptions]="[10, 25, 50, 100]"
    showFirstLastButtons
  ></mat-paginator>
</mat-card>
